<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced QR Code Generator - VIN NESIA</title>
    
    <!-- SEO & Metadata Optimization -->
    <meta name="description" content="Generate high-quality, professional QR codes with VIN NESIA's advanced QR Code Generator. Features include real-time customization, a built-in QR scanner, bulk generation, gradient colors, custom frames, logo integration, and a sleek modern design. Create QR for URLs, text, WiFi, vCards, emails, SMS, location, files, events, crypto, phone, WhatsApp, social media, and more.">
    <meta name="keywords" content="qr code generator, qr code online, free qr code, qr code scanner, bulk qr code, custom qr code, professional qr, modern qr, dynamic qr, qr code with logo, qr code for website, qr code for business, qr code for marketing, vcard qr code, wifi qr code, gradient qr, frame qr, vin nesia qr, indonesia qr, pembuat kode QR, pemindai kode QR">
    <meta name="author" content="VIN NESIA">
    <link rel="canonical" href="https://qr.vinnesia.my.id">
    <meta name="theme-color" content="#10101a">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://qr.vinnesia.my.id/">
    <meta property="og:title" content="Advanced QR Code Generator - VIN NESIA">
    <meta property="og:description" content="Generate high-quality, professional QR codes with VIN NESIA's advanced QR Code Generator. Features include real-time customization, a built-in QR scanner, bulk generation, gradient colors, custom frames, logo integration, and a sleek modern design.">
    <meta property="og:image" content="https://placehold.co/1200x630/3b82f6/ffffff?text=VINNESIA+QR"> <!-- Placeholder image, replace with actual logo/screenshot -->

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://qr.vinnesia.my.id/">
    <meta property="twitter:title" content="Advanced QR Code Generator - VIN NESIA">
    <meta property="twitter:description" content="Generate high-quality, professional QR codes with VIN NESIA's advanced QR Code Generator. Features include real-time customization, a built-in QR scanner, bulk generation, gradient colors, custom frames, logo integration, and a sleek modern design.">
    <meta property="twitter:image" content="https://placehold.co/1200x630/3b82f6/ffffff?text=VINNESIA+QR"> <!-- Placeholder image, replace with actual logo/screenshot -->

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        /* --- [START] PREMIUM CSS UPGRADE --- */

        /* 1. ROOT VARIABLES & DYNAMIC THEME */
        :root {
            --color-background: #0d0d1a;
            --color-surface: rgba(20, 20, 35, 0.5);
            --color-primary: #3b82f6; /* Blue */
            --color-secondary: #8b5cf6; /* Purple */
            --color-success: #10b981; /* Green */
            --color-warning: #f59e0b; /* Orange */
            --color-danger: #ef4444; /* Red */
            --color-text: #f0f0f5;
            --color-text-muted: #a0a0b0;
            --color-border: rgba(255, 255, 255, 0.1);
            --glass-blur: 16px;
            --transition-speed: 0.4s;
            --border-radius: 12px;
            --input-padding-y: 0.8rem;
            --input-padding-x: 1rem;
            --touch-target-min-size: 48px; /* For accessibility */
        }

        body.light-mode {
            --color-background: #f0f2f5;
            --color-surface: rgba(255, 255, 255, 0.7);
            --color-text: #2c3e50;
            --color-text-muted: #7f8c8d;
            --color-border: rgba(0, 0, 0, 0.1);
        }

        /* 2. ADVANCED ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes aurora {
            0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; }
        }
        @keyframes modal-fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes loading-spinner { to { transform: rotate(360deg); } }
        @keyframes typing { from { width: 0; } to { width: 100%; } }
        @keyframes blink-caret { 50% { border-color: transparent; } }

        #qr-code-container {
            transition: all var(--transition-speed) ease;
            transform-style: preserve-3d;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #qr-code-container:hover {
            transform: perspective(1000px) rotateY(5deg) rotateX(2deg) scale(1.02);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4), 0 0 0 8px rgba(var(--color-primary), 0.2); /* Adjusted for var() */
        }

        .typing-placeholder::placeholder {
            color: transparent;
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--color-success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: all var(--transition-speed) ease-out;
            z-index: 1001;
            min-width: 200px;
            text-align: center;
        }
        .toast-notification.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .toast-notification.danger { background-color: var(--color-danger); }
        .toast-notification.warning { background-color: var(--color-warning); }
        .toast-notification.primary { background-color: var(--color-primary); }


        /* 3. DYNAMIC BACKGROUND & BODY */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.7;
            overflow-x: hidden;
            transition: background var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(at 20% 20%, hsla(220, 80%, 50%, 0.2) 0px, transparent 50%),
                        radial-gradient(at 80% 20%, hsla(280, 80%, 50%, 0.2) 0px, transparent 50%),
                        radial-gradient(at 20% 80%, hsla(180, 80%, 50%, 0.2) 0px, transparent 50%),
                        radial-gradient(at 80% 80%, hsla(340, 80%, 50%, 0.2) 0px, transparent 50%);
            z-index: -1;
            animation: aurora 20s ease infinite;
            background-size: 400% 400%;
        }
        body.light-mode::before {
             background: radial-gradient(at 20% 20%, hsla(220, 80%, 80%, 0.3) 0px, transparent 50%),
                         radial-gradient(at 80% 20%, hsla(280, 80%, 80%, 0.3) 0px, transparent 50%),
                         radial-gradient(at 20% 80%, hsla(180, 80%, 80%, 0.3) 0px, transparent 50%),
                         radial-gradient(at 80% 80%, hsla(340, 80%, 80%, 0.3) 0px, transparent 50%);
        }

        /* 4. LAYOUT & HEADER */
        .container { 
            width: 95%; /* More fluid width for all devices */
            max-width: 1200px; 
            margin: 2rem auto; 
            animation: fadeIn 1s ease-out forwards; 
        }
        header { text-align: center; padding: 2rem 1rem; }
        header h1 { 
            margin: 0; 
            font-size: clamp(2em, 5vw, 3em); /* Responsive font size */
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 1rem; 
        }
        header p { 
            color: var(--color-text-muted); 
            font-size: clamp(1em, 2vw, 1.2em); /* Responsive font size */
            margin-top: 0.5rem; 
            max-width: 600px; 
            margin-left: auto; 
            margin-right: auto; 
        }
        .logo-img { height: clamp(40px, 8vw, 50px); } /* Responsive logo size */
        main { 
            display: grid; 
            grid-template-columns: 2fr 1fr; 
            gap: 2rem; 
            align-items: flex-start; 
        }

        /* 5. PROFESSIONAL CARD STYLING */
        .controls, .output, .modal-content {
            background: var(--color-surface);
            padding: 2rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--color-border);
            backdrop-filter: blur(var(--glass-blur));
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: all var(--transition-speed) ease;
        }
        .output { position: sticky; top: 2rem; }

        /* 6. ENHANCED TABS */
        .tabs-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 0.5rem; 
            border-bottom: 1px solid var(--color-border); 
            padding-bottom: 1.5rem; 
            margin-bottom: 1.5rem; 
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .tabs-container::-webkit-scrollbar { height: 0; display: none; } /* Hide scrollbar */
        .tab-button {
            display: flex; align-items: center; justify-content: center; gap: 0.5rem; 
            padding: 0.6rem 0.8rem;
            min-height: var(--touch-target-min-size); /* Ensure touch-friendly size */
            box-sizing: border-box; /* Include padding in min-height */
            cursor: pointer; border: 1px solid transparent; background: transparent; color: var(--color-text-muted);
            border-radius: var(--border-radius); transition: all 0.2s ease;
            font-size: 0.9em; font-weight: 600; white-space: nowrap;
        }
        .tab-button:hover { background-color: rgba(255, 255, 255, 0.05); color: var(--color-text); }
        .tab-button.active {
            background: var(--color-primary); color: white; border-color: var(--color-primary);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); transform: translateY(-2px);
        }
        .tabs-content-viewport { overflow: hidden; position: relative; min-height: 280px; }
        .tabs-content-wrapper { display: flex; transition: transform var(--transition-speed) cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .tab-content { width: 100%; flex-shrink: 0; display: block; padding-top: 0.5rem; }
        
        /* 7. PREMIUM FORM ELEMENTS */
        .form-group { margin-bottom: 1.2rem; position: relative; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--color-text); font-size: 0.9em; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: var(--input-padding-y) var(--input-padding-x); border: 1px solid var(--color-border);
            border-radius: 8px; box-sizing: border-box; font-size: 1em;
            background-color: rgba(0,0,0,0.3); color: var(--color-text);
            transition: all var(--transition-speed) ease;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none; border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }
        .form-row { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Responsive grid for form rows */
            gap: 1rem; 
        }

        /* Validation messages */
        .validation-message {
            font-size: 0.85em;
            color: var(--color-danger);
            margin-top: 0.4rem;
            display: none;
            /* position: absolute; - Removed for better flow on smaller screens, let it be static */
            /* bottom: -1.5rem; */
            left: 0;
        }
        .form-group.invalid input, .form-group.invalid textarea {
            border-color: var(--color-danger);
        }
        .form-group.invalid .validation-message {
            display: block;
        }
        .character-counter {
            font-size: 0.8em;
            color: var(--color-text-muted);
            text-align: right;
            margin-top: 0.2rem;
        }
        .character-counter.warning { color: var(--color-warning); }
        .character-counter.danger { color: var(--color-danger); }


        /* Drag & Drop Upload */
        .drop-zone {
            border: 2px dashed var(--color-border);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 1rem;
        }
        .drop-zone.hover {
            border-color: var(--color-primary);
            background-color: rgba(59, 130, 246, 0.1);
        }
        .drop-zone p { margin: 0; color: var(--color-text-muted); }
        .drop-zone i { font-size: 2em; color: var(--color-primary); margin-bottom: 0.5rem; }

        /* 8. EXPERT DESIGN OPTIONS */
        .collapsible-header {
            cursor: pointer; font-size: 1.2em; font-weight: 700; display: flex;
            align-items: center; justify-content: space-between;
            padding: 1rem 0; border-top: 1px solid var(--color-border); margin-top: 2rem;
            color: var(--color-text);
        }
        .collapsible-header i.fa-chevron-down { transition: transform var(--transition-speed) ease; }
        .collapsible-content { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height var(--transition-speed) ease-out, padding-top var(--transition-speed) ease-out; /* Include padding for smooth collapse */
            padding-top: 0;
        }
        .collapsible-content.open { 
            max-height: 2000px; /* Arbitrary large value */ 
            padding-top: 1rem;
        }
        .collapsible.open .fa-chevron-down { transform: rotate(180deg); }
        .design-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 1.2rem; 
            padding-top: 1rem;
        }
        
        #logo-palette { display: flex; gap: 0.5rem; margin-top: 0.8rem; flex-wrap: wrap; }
        .palette-color { 
            width: 36px; height: 36px; /* Slightly larger touch target */
            border-radius: 50%; cursor: pointer; 
            border: 2px solid var(--color-border); transition: transform 0.2s ease, border-color 0.2s ease; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            min-width: var(--touch-target-min-size); /* Ensure minimum touch size */
            min-height: var(--touch-target-min-size); /* Ensure minimum touch size */
        }
        .palette-color:hover { transform: scale(1.2); border-color: var(--color-primary); }

        /* Gradient Color Pickers */
        .gradient-picker {
            display: flex; align-items: center; gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .gradient-picker input[type="color"] {
            width: 44px; /* Larger touch target */
            height: 44px; /* Larger touch target */
            padding: 2px;
            border-radius: 50%;
            border: 2px solid var(--color-border);
            cursor: pointer;
            background: transparent;
            box-sizing: border-box;
        }
        .gradient-picker button {
            background: none;
            border: none;
            color: var(--color-danger);
            cursor: pointer;
            font-size: 1.2em;
            padding: 8px; /* For touch target */
            min-width: var(--touch-target-min-size);
            min-height: var(--touch-target-min-size);
            box-sizing: border-box;
            border-radius: var(--border-radius); /* Soften corners */
            transition: color 0.2s ease, background-color 0.2s ease;
        }
        .gradient-picker button:hover {
            color: var(--color-text);
            background-color: rgba(255,255,255,0.1);
        }
        .gradient-options {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 1rem;
            margin-top: 0.5rem;
            align-items: center;
        }
        .gradient-options label { margin-right: 0.2rem; }


        /* 9. QR CODE OUTPUT & ACTIONS */
        .output-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 1.5rem; }
        .output-header h2 { margin: 0; font-size: 1.2em; }
        #qr-code-container {
            width: 100%; aspect-ratio: 1 / 1; margin-bottom: 1.5rem;
            padding: 1rem; border-radius: var(--border-radius);
            box-shadow: 0 0 30px rgba(0,0,0,0.5); box-sizing: border-box;
        }
        #qr-code canvas, #qr-code svg { 
            border-radius: 8px; display: block; width: 100% !important; height: auto !important; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .qr-loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: loading-spinner 1s linear infinite;
            position: absolute;
            z-index: 2;
            display: none;
        }
        #qr-code-container.loading .qr-loading-spinner { display: block; }
        #qr-code-container.loading #qr-code { opacity: 0.5; }


        .btn {
            width: 100%; padding: 0.9rem 1.5rem; border-radius: 8px; cursor: pointer;
            font-size: 1em; font-weight: bold; text-align: center;
            transition: all var(--transition-speed) ease; text-decoration: none; border: none;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            min-height: var(--touch-target-min-size); /* Ensure touch-friendly size */
            box-sizing: border-box;
        }
        .btn-primary { background: var(--color-primary); color: white; }
        .btn-primary:hover { background: #405de0; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(59, 130, 246, 0.4); }
        .btn-secondary { background: var(--color-secondary); color: white; }
        .btn-secondary:hover { background: #6c42d0; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(139, 92, 246, 0.4); }
        .btn-outline {
            background: transparent; border: 1px solid var(--color-border); color: var(--color-text-muted);
        }
        .btn-outline:hover {
            border-color: var(--color-primary); color: var(--color-primary);
            background-color: rgba(59, 130, 246, 0.1); transform: translateY(-2px);
        }

        .download-buttons { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* Responsive buttons */
            gap: 1rem; 
            width: 100%; 
        }

        /* 10. MODAL STYLES (SCANNER & BULK) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px);
            z-index: 1000; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: all var(--transition-speed) ease;
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--color-surface); border: 1px solid var(--color-border);
            border-radius: var(--border-radius); padding: 2rem;
            width: 90%; max-width: 600px;
            animation: modal-fade-in var(--transition-speed) ease forwards;
            max-height: 90vh; /* Limit modal height */
            overflow-y: auto; /* Allow scrolling within modal */
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2 { margin: 0; }
        .modal-close-btn { 
            background: none; border: none; color: var(--color-text-muted); 
            font-size: 1.5rem; cursor: pointer; 
            min-width: var(--touch-target-min-size); /* Ensure touch-friendly size */
            min-height: var(--touch-target-min-size);
            box-sizing: border-box;
            border-radius: 50%;
            transition: color 0.2s ease, background-color 0.2s ease;
        }
        .modal-close-btn:hover {
            color: var(--color-text);
            background-color: rgba(255,255,255,0.1);
        }
        #qr-scanner-container { width: 100%; border-radius: 8px; overflow: hidden; margin-bottom: 1rem; }
        #scanner-result { word-break: break-all; background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; }

        /* Dark/Light Mode Toggle */
        .theme-toggle-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100;
        }
        .theme-toggle-button {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 50%;
            width: var(--touch-target-min-size); /* Ensure touch-friendly size */
            height: var(--touch-target-min-size);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 1.2em;
            color: var(--color-text);
            transition: all var(--transition-speed) ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }
        .theme-toggle-button:hover {
            transform: scale(1.1);
            border-color: var(--color-primary);
        }


        /* 11. RESPONSIVE DESIGN */
        @media (max-width: 992px) {
            main { grid-template-columns: 1fr; }
            .output { position: static; margin-top: 2rem; }
            .tabs-container {
                grid-auto-flow: column; /* Allow items to flow in columns for horizontal scroll */
                grid-auto-columns: minmax(100px, 1fr); /* Ensure columns take up available space */
                overflow-x: auto; /* Enable horizontal scrolling */
                padding-bottom: 1rem; /* Add some padding for scrollbar visibility */
            }
            .tabs-container::-webkit-scrollbar {
                display: block; /* Show scrollbar for horizontal scrolling */
                height: 8px;
            }
            .tabs-container::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
            }
            .tabs-container::-webkit-scrollbar-thumb {
                background: var(--color-primary);
                border-radius: 10px;
            }
            .tabs-container[data-mobile-grid="3"] {
                grid-template-columns: repeat(3, minmax(100px, 1fr)); /* Keep 3-grid for mobile portrait, but still allow scroll */
                grid-auto-flow: unset; /* Override column flow for explicit 3-column grid */
            }
        }
        
        @media (max-width: 768px) {
            .container { margin: 1rem auto; width: 98%; }
            header { padding: 1rem 0.5rem; }
            header h1 { font-size: 1.8em; }
            header p { font-size: 0.9em; }
            .tabs-container { 
                grid-template-columns: repeat(3, 1fr); /* Enforce 3 columns as requested */
                justify-content: start;
            }
            .tab-button {
                font-size: 0.8em;
                padding: 0.6rem 0.5rem;
                min-height: 44px; /* Explicit minimum touch target for smaller screens */
            }
            .form-row { grid-template-columns: 1fr; }
            .download-buttons { grid-template-columns: 1fr; }
            .controls, .output, .modal-content { padding: 1rem; }
            .collapsible-header { font-size: 1em; }
            .design-grid { grid-template-columns: 1fr; }
            .toast-notification {
                left: 10px;
                right: 10px;
                width: auto;
                bottom: 10px;
            }
        }

        /* --- [END] PREMIUM CSS UPGRADE --- */
    </style>
</head>
<body>

    <header>
        <h1><img src="logo.png" onerror="this.onerror=null;this.src='https://placehold.co/50x50/3b82f6/ffffff?text=VN';" alt="VIN NESIA Logo" class="logo-img"> VIN NESIA</h1>
        <p>A Premium QR Code Suite. Generate, customize, scan, and bulk-create QR codes with a professional, real-time interface.</p>
    </header>

    <main class="container">
        <div class="controls" role="region" aria-label="QR Code Generator Controls">
            <div class="tabs-container" role="tablist" aria-label="QR Code Types" data-mobile-grid="3">
                <button class="tab-button active" role="tab" aria-selected="true" id="tab-text" data-tab-index="0" data-tab-name="text" onclick="App.openTab(event, 'text')"><i class="fas fa-font" aria-hidden="true"></i> Text/URL</button>
                <button class="tab-button" role="tab" aria-selected="false" id="tab-wifi" data-tab-index="1" data-tab-name="wifi" onclick="App.openTab(event, 'wifi')"><i class="fas fa-wifi" aria-hidden="true"></i> WiFi</button>
                <button class="tab-button" role="tab" aria-selected="false" id="tab-vcard" data-tab-index="2" data-tab-name="vcard" onclick="App.openTab(event, 'vcard')"><i class="fas fa-address-card" aria-hidden="true"></i> vCard</button>
                <button class="tab-button" role="tab" aria-selected="false" id="tab-email" data-tab-index="3" data-tab-name="email" onclick="App.openTab(event, 'email')"><i class="fas fa-envelope" aria-hidden="true"></i> Email</button>
                <button class="tab-button" role="tab" aria-selected="false" id="tab-sms" data-tab-index="4" data-tab-name="sms" onclick="App.openTab(event, 'sms')"><i class="fas fa-sms" aria-hidden="true"></i> SMS</button>
                <button class="tab-button" role="tab" aria-selected="false" id="tab-location" data-tab-index="5" data-tab-name="location" onclick="App.openTab(event, 'location')"><i class="fas fa-map-marker-alt" aria-hidden="true"></i> Location</button>
                <button class="tab-button" role="tab" aria-selected="false" id="tab-file" data-tab-index="6" data-tab-name="file" onclick="App.openTab(event, 'file')"><i class="fas fa-file-alt" aria-hidden="true"></i> File</button>
                <button class="tab-button" role="tab" aria-selected="false" id="tab-event" data-tab-index="7" data-tab-name="event" onclick="App.openTab(event, 'event')"><i class="fas fa-calendar-alt" aria-hidden="true"></i> Event</button>
                <button class="tab-button" role="tab" aria-selected="false" id="tab-crypto" data-tab-index="8" data-tab-name="crypto" onclick="App.openTab(event, 'crypto')"><i class="fab fa-bitcoin" aria-hidden="true"></i> Crypto</button>
                <button class="tab-button" role="tab" aria-selected="false" id="tab-phone" data-tab-index="9" data-tab-name="phone" onclick="App.openTab(event, 'phone')"><i class="fas fa-phone" aria-hidden="true"></i> Phone</button>
                <button class="tab-button" role="tab" aria-selected="false" id="tab-whatsapp" data-tab-index="10" data-tab-name="whatsapp" onclick="App.openTab(event, 'whatsapp')"><i class="fab fa-whatsapp" aria-hidden="true"></i> WhatsApp</button>
                <button class="tab-button" role="tab" aria-selected="false" id="tab-social" data-tab-index="11" data-tab-name="social" onclick="App.openTab(event, 'social')"><i class="fas fa-share-alt" aria-hidden="true"></i> Social</button>
                <button class="tab-button" role="tab" aria-selected="false" id="tab-appstore" data-tab-index="12" data-tab-name="appstore" onclick="App.openTab(event, 'appstore')"><i class="fab fa-app-store-ios" aria-hidden="true"></i> App Store</button>
                <button class="tab-button" role="tab" aria-selected="false" id="tab-multilang" data-tab-index="13" data-tab-name="multilang" onclick="App.openTab(event, 'multilang')"><i class="fas fa-globe" aria-hidden="true"></i> Multi-Lang</button>
                <button class="tab-button" role="tab" aria-selected="false" id="tab-html" data-tab-index="14" data-tab-name="html" onclick="App.openTab(event, 'html')"><i class="fab fa-html5" aria-hidden="true"></i> HTML</button>
            </div>

            <div class="tabs-content-viewport">
                <div class="tabs-content-wrapper" role="tabpanel" aria-labelledby="tab-text">
                    <div id="text" class="tab-content" role="tabpanel" aria-labelledby="tab-text">
                        <div class="form-group">
                            <label for="text-input">Your URL or Text</label>
                            <textarea class="qr-input typing-placeholder" id="text-input" placeholder="e.g., https://www.vinnesia.my.id"></textarea>
                            <span class="validation-message" role="alert" aria-live="polite">Please enter valid URL or text.</span>
                            <div class="character-counter" id="text-input-counter" aria-live="polite">0/250</div>
                            <button class="btn btn-outline mt-2 copy-to-clipboard" data-target="text-input" aria-label="Copy text to clipboard"><i class="fas fa-copy" aria-hidden="true"></i> Copy Text</button>
                        </div>
                    </div>
                    <div id="wifi" class="tab-content" role="tabpanel" aria-labelledby="tab-wifi"></div>
                    <div id="vcard" class="tab-content" role="tabpanel" aria-labelledby="tab-vcard"></div>
                    <div id="event" class="tab-content" role="tabpanel" aria-labelledby="tab-event"></div>
                    <div id="email" class="tab-content" role="tabpanel" aria-labelledby="tab-email"></div>
                    <div id="sms" class="tab-content" role="tabpanel" aria-labelledby="tab-sms"></div>
                    <div id="location" class="tab-content" role="tabpanel" aria-labelledby="tab-location"></div>
                    <div id="file" class="tab-content" role="tabpanel" aria-labelledby="tab-file"></div>
                    <div id="crypto" class="tab-content" role="tabpanel" aria-labelledby="tab-crypto"></div>
                    <div id="phone" class="tab-content" role="tabpanel" aria-labelledby="tab-phone"></div>
                    <div id="whatsapp" class="tab-content" role="tabpanel" aria-labelledby="tab-whatsapp"></div>
                    <div id="social" class="tab-content" role="tabpanel" aria-labelledby="tab-social"></div>
                    <div id="appstore" class="tab-content" role="tabpanel" aria-labelledby="tab-appstore"></div>
                    <div id="multilang" class="tab-content" role="tabpanel" aria-labelledby="tab-multilang"></div>
                    <div id="html" class="tab-content" role="tabpanel" aria-labelledby="tab-html"></div>
                </div>
            </div>

            <div id="design-options-collapsible" class="collapsible" role="group" aria-label="QR Code Design Options">
                <div class="collapsible-header" role="button" aria-expanded="false" aria-controls="design-content-panel" tabindex="0">
                    <span><i class="fas fa-palette" aria-hidden="true"></i> Expert Design Options</span>
                    <i class="fas fa-chevron-down" aria-hidden="true"></i>
                </div>
                <div class="collapsible-content" id="design-content-panel">
                    <div class="design-grid">
                        <div class="form-group"><label for="dot-style">Dot Style</label><select class="qr-input" id="dot-style"><option value="square">Square</option><option value="dots">Dots</option><option value="rounded">Rounded</option><option value="extra-rounded">Extra Rounded</option><option value="classy">Classy</option><option value="classy-rounded">Classy Rounded</option></select></div>
                        <div class="form-group"><label for="dot-color">Dot Color</label><input type="color" class="qr-input" id="dot-color" value="#3b82f6"></div>
                        <div class="form-group">
                            <label>Dot Gradient</label>
                            <div id="dot-gradient-colors">
                                <div class="gradient-picker">
                                    <input type="color" class="qr-input" data-gradient-stop="0" value="#3b82f6" aria-label="Dot gradient start color">
                                    <input type="color" class="qr-input" data-gradient-stop="1" value="#8b5cf6" aria-label="Dot gradient end color">
                                    <button onclick="App.addGradientColor('dot')" aria-label="Add dot gradient color"><i class="fas fa-plus-circle" aria-hidden="true"></i></button>
                                </div>
                            </div>
                            <div class="gradient-options">
                                <label for="dot-gradient-type">Type:</label>
                                <select class="qr-input" id="dot-gradient-type" aria-label="Dot gradient type">
                                    <option value="radial">Radial</option>
                                    <option value="linear">Linear</option>
                                </select>
                                <label for="dot-gradient-rotation">Rotation:</label>
                                <input type="range" class="qr-input" id="dot-gradient-rotation" min="0" max="360" value="0" aria-valuenow="0" aria-valuemin="0" aria-valuemax="360" aria-label="Dot gradient rotation">
                                <span><span id="dot-gradient-rotation-value">0</span>°</span>
                            </div>
                        </div>

                        <div class="form-group"><label for="bg-color">Background Color</label><input type="color" class="qr-input" id="bg-color" value="#0d0d1a"></div>
                        <div class="form-group">
                            <label>Background Gradient</label>
                            <div id="bg-gradient-colors">
                                <div class="gradient-picker">
                                    <input type="color" class="qr-input" data-gradient-stop="0" value="#0d0d1a" aria-label="Background gradient start color">
                                    <input type="color" class="qr-input" data-gradient-stop="1" value="#1a1a2e" aria-label="Background gradient end color">
                                    <button onclick="App.addGradientColor('bg')" aria-label="Add background gradient color"><i class="fas fa-plus-circle" aria-hidden="true"></i></button>
                                </div>
                            </div>
                            <div class="gradient-options">
                                <label for="bg-gradient-type">Type:</label>
                                <select class="qr-input" id="bg-gradient-type" aria-label="Background gradient type">
                                    <option value="radial">Radial</option><option value="linear">Linear</option>
                                </select>
                                <label for="bg-gradient-rotation">Rotation:</label>
                                <input type="range" class="qr-input" id="bg-gradient-rotation" min="0" max="360" value="0" aria-valuenow="0" aria-valuemin="0" aria-valuemax="360" aria-label="Background gradient rotation">
                                <span><span id="bg-gradient-rotation-value">0</span>°</span>
                            </div>
                        </div>

                        <div class="form-group"><label for="corner-square-style">Corner Square Style</label><select class="qr-input" id="corner-square-style"><option value="square">Square</option><option value="extra-rounded">Extra Rounded</option><option value="dot">Dot</option></select></div>
                        <div class="form-group"><label for="corner-square-color">Corner Square Color</label><input type="color" class="qr-input" id="corner-square-color" value="#3b82f6"></div>
                        
                        <div class="form-group"><label for="corner-dot-style">Corner Dot Style</label><select class="qr-input" id="corner-dot-style"><option value="square">Square</option><option value="dot">Dot</option></select></div>
                        <div class="form-group"><label for="corner-dot-color">Corner Dot Color</label><input type="color" class="qr-input" id="corner-dot-color" value="#3b82f6"></div>

                        <div class="form-group"><label for="margin">Margin</label><input type="number" class="qr-input" id="margin" value="0" min="0" max="100" aria-label="QR Code margin"></div>
                        <div class="form-group"><label for="image-size">Image Size</label><input type="range" class="qr-input" id="image-size" min="0.1" max="1" step="0.05" value="0.4" aria-valuenow="0.4" aria-valuemin="0.1" aria-valuemax="1" aria-label="Logo image size in QR code"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="logo-upload">Upload Logo</label>
                        <div class="drop-zone" id="logo-drop-zone" role="group" aria-label="Drag and drop area for logo upload">
                            <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                            <p>Drag & drop your logo here or click to upload</p>
                            <input type="file" id="logo-upload" accept="image/*" style="display:none;" aria-label="Upload logo file">
                            <button type="button" class="btn btn-outline mt-2" onclick="document.getElementById('logo-upload').click();" aria-label="Choose logo file"><i class="fas fa-upload" aria-hidden="true"></i> Choose Logo</button>
                        </div>
                        <div id="logo-palette-container" style="display: none; margin-top: 1rem;">
                            <label>Smart Palette (from Logo)</label>
                            <div id="logo-palette" role="group" aria-label="Extracted color palette from logo"></div>
                        </div>
                        <div id="logo-controls" style="display: none; margin-top: 1rem;" role="group" aria-label="Logo positioning controls">
                            <div class="form-group">
                                <label for="logo-position-x">Logo Position X (px)</label>
                                <input type="number" class="qr-input" id="logo-position-x" value="0" aria-label="Logo horizontal position">
                            </div>
                            <div class="form-group">
                                <label for="logo-position-y">Logo Position Y (px)</label>
                                <input type="number" class="qr-input" id="logo-position-y" value="0" aria-label="Logo vertical position">
                            </div>
                            <button class="btn btn-outline" onclick="App.removeLogo()" aria-label="Remove uploaded logo"><i class="fas fa-times-circle" aria-hidden="true"></i> Remove Logo</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="frame-text">Frame Text (e.g., SCAN ME)</label>
                        <input type="text" class="qr-input" id="frame-text" placeholder="SCAN ME" aria-label="Text to display in QR frame">
                    </div>
                    <div class="form-group">
                        <label for="frame-color">Frame Color</label>
                        <input type="color" class="qr-input" id="frame-color" value="#3b82f6" aria-label="QR frame color">
                    </div>
                    <div class="form-group">
                        <label for="frame-font-color">Frame Font Color</label>
                        <input type="color" class="qr-input" id="frame-font-color" value="#ffffff" aria-label="QR frame font color">
                    </div>
                    <div class="form-group">
                        <label for="frame-corner-radius">Frame Corner Radius (%)</label>
                        <input type="range" class="qr-input" id="frame-corner-radius" min="0" max="50" value="0" aria-valuenow="0" aria-valuemin="0" aria-valuemax="50" aria-label="QR frame corner radius">
                        <span><span id="frame-corner-radius-value">0</span>%</span>
                    </div>
                </div>
            </div>

            <div id="recent-qrs-collapsible" class="collapsible mt-4" role="region" aria-label="Recent QR Codes History">
                <div class="collapsible-header" role="button" aria-expanded="false" aria-controls="history-content-panel" tabindex="0">
                    <span><i class="fas fa-history" aria-hidden="true"></i> Recent QR Codes</span>
                    <i class="fas fa-chevron-down" aria-hidden="true"></i>
                </div>
                <div class="collapsible-content" id="history-content-panel">
                    <ul id="qr-history-list" class="list-disc pl-5 py-2" role="list">
                        <!-- History items will be loaded here -->
                    </ul>
                    <button class="btn btn-outline mt-2" onclick="App.clearHistory()" aria-label="Clear all QR code history"><i class="fas fa-trash-alt" aria-hidden="true"></i> Clear History</button>
                </div>
            </div>
        </div>

        <div class="output" role="region" aria-label="QR Code Preview and Download">
            <div class="output-header">
                <h2>Preview</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <button id="scan-qr-btn" class="btn btn-outline" style="width:auto; padding: 0.5rem 1rem;" aria-label="Open QR Code Scanner"><i class="fas fa-qrcode" aria-hidden="true"></i> Scan</button>
                    <button id="bulk-qr-btn" class="btn btn-outline" style="width:auto; padding: 0.5rem 1rem;" aria-label="Open Bulk QR Code Generator"><i class="fas fa-layer-group" aria-hidden="true"></i> Bulk</button>
                </div>
            </div>
            <div id="qr-code-container" aria-live="polite" aria-atomic="true">
                <div class="qr-loading-spinner" role="status" aria-label="QR Code is generating"></div>
                <div id="qr-code"></div>
            </div>
            <div class="download-buttons">
                <button id="download-png" class="btn btn-primary" aria-label="Download QR Code as PNG"><i class="fas fa-file-image" aria-hidden="true"></i> Download PNG</button>
                <button id="download-svg" class="btn btn-secondary" aria-label="Download QR Code as SVG"><i class="fas fa-file-code" aria-hidden="true"></i> Download SVG</button>
            </div>
        </div>
    </main>

    <div id="scanner-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="scanner-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="scanner-modal-title">QR Code Scanner</h2>
                <button class="modal-close-btn" aria-label="Close scanner modal">&times;</button>
            </div>
            <div id="qr-scanner-container" aria-label="QR Code live scanner feed"></div>
            <p><strong>Result:</strong> <span id="scanner-result" aria-live="polite" aria-atomic="true">Align QR code within the frame.</span></p>
            <button class="btn btn-primary mt-3 copy-to-clipboard" data-target="scanner-result" aria-label="Copy scanner result to clipboard"><i class="fas fa-copy" aria-hidden="true"></i> Copy Result</button>
        </div>
    </div>
    
    <div id="bulk-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="bulk-modal-title">
         <div class="modal-content">
            <div class="modal-header">
                <h2 id="bulk-modal-title">Bulk QR Code Generator</h2>
                <button class="modal-close-btn" aria-label="Close bulk generator modal">&times;</button>
            </div>
            <p class="text-sm text-gray-400 mb-4">Enter data, one QR code per line. For vCards, use CSV format: "FullName,Email,Phone".</p>
            <div class="form-group">
                <label for="bulk-type">QR Code Type for Bulk</label>
                <select id="bulk-type" class="qr-input" aria-label="Select QR code type for bulk generation">
                    <option value="text">URL/Text</option>
                    <option value="wifi">WiFi</option>
                    <option value="vcard">vCard (CSV)</option>
                    <option value="email">Email</option>
                    <option value="sms">SMS</option>
                    <option value="location">Location</option>
                    <option value="phone">Phone</option>
                    <option value="whatsapp">WhatsApp</option>
                </select>
            </div>
            <div class="form-group">
                <label for="bulk-data">Data for Bulk Generation</label>
                <textarea id="bulk-data" rows="8" placeholder="https://google.com&#10;https://vinnesia.my.id&#10;John Doe,john@email.com,+12345" aria-label="Input data for bulk QR code generation"></textarea>
            </div>
            <button id="bulk-generate-zip" class="btn btn-primary" aria-label="Generate and download all QR codes as ZIP"><i class="fas fa-file-archive" aria-hidden="true"></i> Generate & Download ZIP</button>
        </div>
    </div>

    <div id="toast-notification" class="toast-notification" role="status" aria-live="polite"></div>

    <div class="theme-toggle-container">
        <button id="theme-toggle-button" class="theme-toggle-button" aria-label="Toggle dark/light mode">
            <i class="fas fa-sun" aria-hidden="true"></i>
        </button>
    </div>
    
    <script>
    // --- [START] ADVANCED JAVASCRIPT ---

    const App = {
        qrCode: null,
        html5QrCode: null,
        logoImage: null,
        debounceTimer: null,
        state: { 
            currentTab: 'text', 
            currentTabIndex: 0,
            qrHistory: JSON.parse(localStorage.getItem('qrHistory')) || [],
            appSettings: JSON.parse(localStorage.getItem('appSettings')) || { theme: 'dark', dotGradientColors: ['#3b82f6', '#8b5cf6'], bgGradientColors: ['#0d0d1a', '#1a1a2e'] },
            undoStack: [],
            redoStack: []
        },
        placeholderTexts: {
            text: "e.g., https://www.vinnesia.my.id",
            wifi: "Network Name (SSID)",
            vcard: "Full Name, Email, Phone, Organization...",
            email: "recipient@example.com",
            sms: "+1234567890",
            location: "Latitude, Longitude",
            file: "Drag & drop your file here...",
            event: "Event Title, Start Time, End Time, Location...",
            crypto: "Wallet Address, Amount...",
            phone: "+1234567890",
            whatsapp: "+1234567890",
            social: "Social Media URL (e.g., linkedin.com/in/vinnesia)",
            appstore: "App Store URL",
            multilang: "Lang1 Text::Lang2 Text",
            html: "HTML content for web page..."
        },
        typingAnimationInterval: null,
        maxHistoryItems: 50,

        // Moved loadInitialContent definition before init
        loadInitialContent() {
            const content = {
                wifi: `<div class="form-group"><label for="wifi-ssid">Network Name (SSID)</label><input type="text" class="qr-input" id="wifi-ssid" placeholder="MyWiFiNetwork"><span class="validation-message" role="alert" aria-live="polite">SSID cannot be empty.</span></div><div class="form-group"><label for="wifi-password">Password</label><input type="password" class="qr-input" id="wifi-password" placeholder="Password (leave blank for open network)"></div><div class="form-group"><label for="wifi-encryption">Encryption</label><select class="qr-input" id="wifi-encryption"><option value="WPA">WPA/WPA2</option><option value="WEP">WEP</option><option value="nopass">No Encryption</option></select></div>`,
                vcard: `<div class="form-row"><div class="form-group"><label for="vcard-name">Full Name</label><input type="text" class="qr-input" id="vcard-name" placeholder="John Doe"><span class="validation-message" role="alert" aria-live="polite">Full Name is required.</span></div><div class="form-group"><label for="vcard-org">Organization</label><input type="text" class="qr-input" id="vcard-org" placeholder="Acme Corp"></div></div><div class="form-row"><div class="form-group"><label for="vcard-phone">Phone</label><input type="tel" class="qr-input" id="vcard-phone" placeholder="+1234567890"></div><div class="form-group"><label for="vcard-email">Email</label><input type="email" class="qr-input" id="vcard-email" placeholder="john.doe@example.com"><span class="validation-message" role="alert" aria-live="polite">Enter a valid email.</span></div></div><div class="form-group"><label for="vcard-url">Website</label><input type="url" class="qr-input" id="vcard-url" placeholder="https://example.com"></div><div class="form-group"><label for="vcard-address">Address</label><input type="text" class="qr-input" id="vcard-address" placeholder="123 Main St, City, Country"></div><div class="form-group"><label for="vcard-title">Title</label><input type="text" class="qr-input" id="vcard-title" placeholder="Software Engineer"></div>`,
                event: `<div class="form-group"><label for="event-summary">Event Title</label><input type="text" class="qr-input" id="event-summary" placeholder="Team Meeting"><span class="validation-message" role="alert" aria-live="polite">Event Title is required.</span></div><div class="form-group"><label for="event-location">Location</label><input type="text" class="qr-input" id="event-location" placeholder="Conference Room A"></div><div class="form-group"><label for="event-start">Start Time</label><input type="datetime-local" class="qr-input" id="event-start"><span class="validation-message" role="alert" aria-live="polite">Start Time is required.</span></div><div class="form-group"><label for="event-end">End Time</label><input type="datetime-local" class="qr-input" id="event-end"></div><div class="form-group"><label for="event-description">Description</label><textarea class="qr-input" id="event-description" placeholder="Agenda for the weekly sync-up"></textarea></div>`,
                email: `<div class="form-group"><label for="email-to">Recipient Email</label><input type="email" class="qr-input" id="email-to" placeholder="recipient@example.com"><span class="validation-message" role="alert" aria-live="polite">Enter a valid email.</span></div><div class="form-group"><label for="email-subject">Subject</label><input type="text" class="qr-input" id="email-subject" placeholder="Meeting Request"></div><div class="form-group"><label for="email-body">Message Body</label><textarea class="qr-input" id="email-body" placeholder="Hi, I'd like to discuss..."></textarea></div>`,
                sms: `<div class="form-group"><label for="sms-number">Phone Number</label><input type="tel" class="qr-input" id="sms-number" placeholder="+1234567890"><span class="validation-message" role="alert" aria-live="polite">Enter a valid phone number.</span></div><div class="form-group"><label for="sms-message">Message</label><textarea class="qr-input" id="sms-message" placeholder="Hello there!"></textarea></div>`,
                location: `<div class="form-row"><div class="form-group"><label for="location-lat">Latitude</label><input type="number" step="any" class="qr-input" id="location-lat" placeholder="34.0522"><span class="validation-message" role="alert" aria-live="polite">Enter a valid latitude.</span></div><div class="form-group"><label for="location-lon">Longitude</label><input type="number" step="any" class="qr-input" id="location-lon" placeholder="-118.2437"><span class="validation-message" role="alert" aria-live="polite">Enter a valid longitude.</span></div></div>`,
                file: `<div class="form-group"><label>Upload File (Max 1MB)</label><div class="drop-zone" id="file-drop-zone" role="group" aria-label="Drag and drop area for file upload"><i class="fas fa-file-upload" aria-hidden="true"></i><p>Drag & drop your file here or click to upload</p><input type="file" id="file-upload" accept=".txt,.pdf,.csv" style="display:none;" aria-label="Upload file"></div><p id="file-upload-name" class="mt-2 text-sm text-gray-400"></p><span class="validation-message" role="alert" aria-live="polite">File size exceeds 1MB.</span><button type="button" class="btn btn-outline mt-2" onclick="document.getElementById('file-upload').click();" aria-label="Choose file to upload"><i class="fas fa-upload" aria-hidden="true"></i> Choose File</button></div>`,
                crypto: `<div class="form-group"><label for="crypto-currency">Currency</label><select class="qr-input" id="crypto-currency"><option value="bitcoin">Bitcoin (BTC)</option><option value="ethereum">Ethereum (ETH)</option></select></div><div class="form-group"><label for="crypto-address">Wallet Address</label><input type="text" class="qr-input" id="crypto-address" placeholder="bc1q..."><span class="validation-message" role="alert" aria-live="polite">Wallet address is required.</span></div><div class="form-group"><label for="crypto-amount">Amount</label><input type="number" step="any" class="qr-input" id="crypto-amount" placeholder="0.001"></div>`,
                phone: `<div class="form-group"><label for="phone-number">Phone Number</label><input type="tel" class="qr-input" id="phone-number" placeholder="+1234567890"><span class="validation-message" role="alert" aria-live="polite">Enter a valid phone number.</span></div>`,
                whatsapp: `<div class="form-group"><label for="whatsapp-number">WhatsApp Number</label><input type="tel" class="qr-input" id="whatsapp-number" placeholder="+1234567890"><span class="validation-message" role="alert" aria-live="polite">Enter a valid WhatsApp number.</span></div><div class="form-group"><label for="whatsapp-message">Message</label><textarea class="qr-input" id="whatsapp-message" placeholder="Hi there!"></textarea></div>`,
                social: `<div class="form-group"><label for="social-url">Social Media Profile URL</label><input type="url" class="qr-input" id="social-url" placeholder="https://linkedin.com/in/vinnesia"><span class="validation-message" role="alert" aria-live="polite">Enter a valid URL.</span></div>`,
                appstore: `<div class="form-group"><label for="appstore-url">App Store Link</label><input type="url" class="qr-input" id="appstore-url" placeholder="https://apps.apple.com/app/id..."><span class="validation-message" role="alert" aria-live="polite">Enter a valid URL.</span></div><div class="form-group"><label for="playstore-url">Play Store Link (Optional)</label><input type="url" class="qr-input" id="playstore-url" placeholder="https://play.google.com/store/apps/details?id..."><span class="validation-message" role="alert" aria-live="polite">Enter a valid URL.</span></div>`,
                multilang: `<div class="form-group"><label for="multilang-default">Default Text</label><textarea class="qr-input" id="multilang-default" placeholder="Hello World"></textarea><span class="validation-message" role="alert" aria-live="polite">Default text is required.</span></div><div class="form-group"><label for="multilang-en">English Text</label><textarea class="qr-input" id="multilang-en" placeholder="Hello World (English)"></textarea></div><div class="form-group"><label for="multilang-id">Indonesian Text</label><textarea class="qr-input" id="multilang-id" placeholder="Halo Dunia (Indonesia)"></textarea></div><p class="text-sm text-gray-400">Add more languages by adding input with id 'multilang-xx' where 'xx' is ISO 639-1 code. Example: multilang-es for Spanish.</p>`,
                html: `<div class="form-group"><label for="html-content">HTML Content</label><textarea class="qr-input" id="html-content" rows="10" placeholder="<h1>Hello</h1><p>From QR Code!</p>"></textarea><span class="validation-message" role="alert" aria-live="polite">HTML content cannot be empty.</span></div>`
            };
            Object.keys(content).forEach(key => {
                const tab = document.getElementById(key);
                if (tab) tab.innerHTML = content[key];
            });
            this.attachEventListenersToDynamicContent();
            this.generateQrCode();
        },

        init() {
            this.loadTheme();
            this.setupQRCode();
            this.attachEventListeners();
            this.loadInitialContent(); // This method is now defined earlier
            this.loadHistory();
            this.applyInitialSettings();
            this.startTypingAnimation('text-input', this.placeholderTexts.text);
            this.setupModalFocusManagement();
            console.log("Premium QR Suite Initialized.");
        },

        loadTheme() {
            if (this.state.appSettings.theme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('theme-toggle-button').innerHTML = '<i class="fas fa-moon" aria-hidden="true"></i>';
            } else {
                document.getElementById('theme-toggle-button').innerHTML = '<i class="fas fa-sun" aria-hidden="true"></i>';
            }
        },

        toggleTheme() {
            document.body.classList.toggle('light-mode');
            this.state.appSettings.theme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            localStorage.setItem('appSettings', JSON.stringify(this.state.appSettings));
            this.loadTheme();
        },

        setupQRCode() {
            this.qrCode = new QRCodeStyling({
                width: 300, height: 300, data: "https://qr.vinnesia.my.id",
                dotsOptions: { color: "#3b82f6", type: "rounded" },
                backgroundOptions: { color: "#0d0d1a" },
                imageOptions: { crossOrigin: "anonymous", margin: 8, imageSize: 0.4 },
                cornersSquareOptions: { color: "#3b82f6", type: "square" },
                cornersDotOptions: { color: "#3b82f6", type: "dot" },
                qrOptions: { errorCorrectionLevel: 'H' }
            });
            this.qrCode.append(document.getElementById("qr-code"));
        },

        attachEventListeners() {
            // Debounced input for QR generation
            document.querySelectorAll('.qr-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    this.saveStateForUndo();
                    this.validateInput(e.target);
                    clearTimeout(this.debounceTimer);
                    this.debounceTimer = setTimeout(() => this.generateQrCode(), 250);
                    this.saveAppSettings();
                    this.updateCharacterCounter(e.target);
                });
            });

            document.getElementById('logo-upload').addEventListener('change', e => this.handleLogoUpload(e.target.files[0]));
            
            // Design Collapsible
            const designCollapsible = document.getElementById('design-options-collapsible');
            const designHeader = designCollapsible.querySelector('.collapsible-header');
            const designContent = designCollapsible.querySelector('.collapsible-content');
            if (designHeader) {
                designHeader.addEventListener('click', () => {
                    const isOpen = designCollapsible.classList.toggle('open');
                    designContent.classList.toggle('open');
                    designHeader.setAttribute('aria-expanded', isOpen);
                });
                designHeader.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        designHeader.click();
                    }
                });
            }

            // Recent QRs Collapsible
            const recentQRsCollapsible = document.getElementById('recent-qrs-collapsible');
            const recentQRsHeader = recentQRsCollapsible.querySelector('.collapsible-header');
            const recentQRsContent = recentQRsCollapsible.querySelector('.collapsible-content');
            if (recentQRsHeader) {
                recentQRsHeader.addEventListener('click', () => {
                    const isOpen = recentQRsCollapsible.classList.toggle('open');
                    recentQRsContent.classList.toggle('open');
                    recentQRsHeader.setAttribute('aria-expanded', isOpen);
                });
                recentQRsHeader.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        recentQRsHeader.click();
                    }
                });
            }

            // Modals
            document.getElementById('scan-qr-btn').addEventListener('click', (e) => {
                this.lastFocusedElement = e.currentTarget;
                this.openModal('scanner-modal');
            });
            document.getElementById('bulk-qr-btn').addEventListener('click', (e) => {
                this.lastFocusedElement = e.currentTarget;
                this.openModal('bulk-modal');
            });
            document.querySelectorAll('.modal-overlay').forEach(el => {
                el.addEventListener('click', e => {
                    if (e.target === el || e.target.classList.contains('modal-close-btn')) {
                        this.closeAllModals();
                    }
                });
                 el.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeAllModals();
                    }
                });
            });

            // Downloads & Bulk
            document.getElementById('download-png').addEventListener('click', () => this.download('png'));
            document.getElementById('download-svg').addEventListener('click', () => this.download('svg'));
            document.getElementById('bulk-generate-zip').addEventListener('click', () => this.handleBulkGenerate());

            // Drag & Drop for Logo
            const dropZone = document.getElementById('logo-drop-zone');
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('hover'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('hover'); });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('hover');
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    this.handleLogoUpload(e.dataTransfer.files[0]);
                }
            });

            // Copy to Clipboard
            document.querySelectorAll('.copy-to-clipboard').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.dataset.target;
                    const targetElement = document.getElementById(targetId) || document.querySelector(`#${targetId} span`);
                    if (targetElement) {
                        this.copyToClipboard(targetElement.value || targetElement.textContent);
                    }
                });
            });

            // Gradient rotation updates
            document.getElementById('dot-gradient-rotation').addEventListener('input', (e) => {
                document.getElementById('dot-gradient-rotation-value').textContent = e.target.value;
                this.generateQrCode();
                this.saveAppSettings();
            });
            document.getElementById('bg-gradient-rotation').addEventListener('input', (e) => {
                document.getElementById('bg-gradient-rotation-value').textContent = e.target.value;
                this.generateQrCode();
                this.saveAppSettings();
            });
            document.getElementById('frame-corner-radius').addEventListener('input', (e) => {
                document.getElementById('frame-corner-radius-value').textContent = e.target.value;
                this.generateQrCode();
                this.saveAppSettings();
            });

            // Theme Toggle
            document.getElementById('theme-toggle-button').addEventListener('click', () => this.toggleTheme());

            // Keyboard Shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    this.generateQrCode();
                    this.showToast('QR Code generated!');
                }
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    this.download('png');
                    this.showToast('Downloading PNG...');
                }
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    this.undo();
                }
                if (e.ctrlKey && e.key === 'y') {
                    e.preventDefault();
                    this.redo();
                }
            });

             // Swipe gestures for tabs (mobile)
            let touchStartX = 0;
            const tabsContentWrapper = document.querySelector('.tabs-content-wrapper');
            tabsContentWrapper.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
            });
            tabsContentWrapper.addEventListener('touchmove', (e) => {
                // To prevent page scrolling when swiping on tabs, uncomment the next line
                // e.preventDefault(); 
            }, { passive: false });

            tabsContentWrapper.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const minSwipeDistance = 50;

                if (touchEndX < touchStartX - minSwipeDistance) {
                    // Swiped left
                    const nextIndex = Math.min(this.state.currentTabIndex + 1, document.querySelectorAll('.tab-content').length - 1);
                    if (nextIndex !== this.state.currentTabIndex) {
                        const nextTabName = document.querySelector(`.tab-button[data-tab-index="${nextIndex}"]`).dataset.tabName;
                        this.openTab(null, nextTabName);
                    }
                } else if (touchEndX > touchStartX + minSwipeDistance) {
                    // Swiped right
                    const prevIndex = Math.max(this.state.currentTabIndex - 1, 0);
                    if (prevIndex !== this.state.currentTabIndex) {
                        const prevTabName = document.querySelector(`.tab-button[data-tab-index="${prevIndex}"]`).dataset.tabName;
                        this.openTab(null, prevTabName);
                    }
                }
            });
        },

        attachEventListenersToDynamicContent() {
            document.querySelectorAll('.qr-input').forEach(input => {
                 if (!input.dataset.listenerAttached) {
                    input.addEventListener('input', (e) => {
                        this.saveStateForUndo();
                        this.validateInput(e.target);
                        clearTimeout(this.debounceTimer);
                        this.debounceTimer = setTimeout(() => this.generateQrCode(), 250);
                        this.saveAppSettings();
                        this.updateCharacterCounter(e.target);
                    });
                    input.dataset.listenerAttached = 'true';
                }
            });

            // File upload for 'file' tab
            const fileDropZone = document.getElementById('file-drop-zone');
            if (fileDropZone) {
                fileDropZone.addEventListener('dragover', (e) => { e.preventDefault(); fileDropZone.classList.add('hover'); });
                fileDropZone.addEventListener('dragleave', () => { fileDropZone.classList.remove('hover'); });
                fileDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('hover');
                    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                        this.handleFileUpload(e.dataTransfer.files[0]);
                    }
                });
                document.getElementById('file-upload').addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files[0]);
                });
            }

            // Copy buttons for dynamically loaded content
            document.querySelectorAll('.tab-content .copy-to-clipboard').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.dataset.target;
                    const targetElement = document.getElementById(targetId) || document.querySelector(`#${targetId} span`);
                    if (targetElement) {
                        this.copyToClipboard(targetElement.value || targetElement.textContent);
                    }
                });
            });

            // Gradient color inputs for dynamically loaded content
            document.querySelectorAll('#dot-gradient-colors input[type="color"], #bg-gradient-colors input[type="color"]').forEach(input => {
                input.addEventListener('input', () => {
                    this.saveStateForUndo();
                    clearTimeout(this.debounceTimer);
                    this.debounceTimer = setTimeout(() => this.generateQrCode(), 250);
                    this.saveAppSettings();
                });
            });
            document.querySelectorAll('#dot-gradient-type, #bg-gradient-type').forEach(select => {
                select.addEventListener('change', () => {
                    this.saveStateForUndo();
                    this.generateQrCode();
                    this.saveAppSettings();
                });
            });
        },
        
        getQrData() {
            let data = "https://qr.vinnesia.my.id";
            switch(this.state.currentTab) {
                case 'text':
                    data = document.getElementById('text-input').value;
                    break;
                case 'wifi':
                    const ssid = document.getElementById('wifi-ssid').value;
                    const password = document.getElementById('wifi-password').value;
                    const encryption = document.getElementById('wifi-encryption').value;
                    data = `WIFI:S:${ssid};T:${encryption};P:${password};;`;
                    break;
                case 'vcard':
                    const vName = document.getElementById('vcard-name').value;
                    const vOrg = document.getElementById('vcard-org').value;
                    const vPhone = document.getElementById('vcard-phone').value;
                    const vEmail = document.getElementById('vcard-email').value;
                    const vUrl = document.getElementById('vcard-url').value;
                    const vAddress = document.getElementById('vcard-address').value;
                    const vTitle = document.getElementById('vcard-title').value;
                    data = `BEGIN:VCARD\nVERSION:3.0\nFN:${vName}\nORG:${vOrg}\nTEL:${vPhone}\nEMAIL:${vEmail}\nURL:${vUrl}\nADR:${vAddress}\nTITLE:${vTitle}\nEND:VCARD`;
                    break;
                case 'event':
                    const eSummary = document.getElementById('event-summary').value;
                    const eLocation = document.getElementById('event-location').value;
                    const eStart = document.getElementById('event-start').value ? new Date(document.getElementById('event-start').value).toISOString().replace(/[-:]|\.\d{3}/g, '') : '';
                    const eEnd = document.getElementById('event-end').value ? new Date(document.getElementById('event-end').value).toISOString().replace(/[-:]|\.\d{3}/g, '') : '';
                    const eDescription = document.getElementById('event-description').value;
                    data = `BEGIN:VEVENT\nSUMMARY:${eSummary}\nLOCATION:${eLocation}\nDTSTART:${eStart}\nDTEND:${eEnd}\nDESCRIPTION:${eDescription}\nEND:VEVENT`;
                    break;
                case 'email':
                    const mailTo = document.getElementById('email-to').value;
                    const mailSubject = document.getElementById('email-subject').value;
                    const mailBody = document.getElementById('email-body').value;
                    data = `mailto:${mailTo}?subject=${encodeURIComponent(mailSubject)}&body=${encodeURIComponent(mailBody)}`;
                    break;
                case 'sms':
                    const smsNumber = document.getElementById('sms-number').value;
                    const smsMessage = document.getElementById('sms-message').value;
                    data = `SMSTO:${smsNumber}:${smsMessage}`;
                    break;
                case 'location':
                    const lat = document.getElementById('location-lat').value;
                    const lon = document.getElementById('location-lon').value;
                    data = `geo:${lat},${lon}`;
                    break;
                case 'file':
                    data = document.getElementById('file-upload-name').dataset.fileContent || "Please upload a file.";
                    break;
                case 'crypto':
                    const currency = document.getElementById('crypto-currency').value;
                    const address = document.getElementById('crypto-address').value;
                    const amount = document.getElementById('crypto-amount').value;
                    data = `${currency}:${address}${amount ? `?amount=${amount}` : ''}`;
                    break;
                case 'phone':
                    const phoneNumber = document.getElementById('phone-number').value;
                    data = `tel:${phoneNumber}`;
                    break;
                case 'whatsapp':
                    const whatsappNumber = document.getElementById('whatsapp-number').value.replace(/\D/g, '');
                    const whatsappMessage = document.getElementById('whatsapp-message').value;
                    data = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(whatsappMessage)}`;
                    break;
                case 'social':
                    data = document.getElementById('social-url').value;
                    break;
                case 'appstore':
                    const appStoreUrl = document.getElementById('appstore-url').value;
                    const playStoreUrl = document.getElementById('playstore-url').value;
                    data = appStoreUrl;
                    if (appStoreUrl && playStoreUrl) {
                        data = `https://linktree.com/?appstore=${encodeURIComponent(appStoreUrl)}&playstore=${encodeURIComponent(playStoreUrl)}`;
                    } else if (playStoreUrl) {
                        data = playStoreUrl;
                    }
                    break;
                case 'multilang':
                    let multiLangData = [];
                    const defaultText = document.getElementById('multilang-default').value;
                    if (defaultText) multiLangData.push(`DEFAULT:${defaultText}`);
                    
                    document.querySelectorAll('[id^="multilang-"]:not(#multilang-default)').forEach(input => {
                        const langCode = input.id.replace('multilang-', '').toUpperCase();
                        if (input.value) multiLangData.push(`${langCode}:${input.value}`);
                    });
                    data = multiLangData.join('\n');
                    break;
                case 'html':
                    data = document.getElementById('html-content').value;
                    break;
            }
            return data || "https://qr.vinnesia.my.id";
        },

        getGradientColors(prefix) {
            const colors = [];
            document.querySelectorAll(`#${prefix}-gradient-colors input[type="color"]`).forEach(input => {
                colors.push(input.value);
            });
            return colors;
        },

        generateQrCode() {
            if (!this.qrCode) return;

            document.getElementById('qr-code-container').classList.add('loading');
            
            const currentInput = document.querySelector(`#${this.state.currentTab} .qr-input`);
            if (currentInput && !this.validateInput(currentInput, true)) {
                document.getElementById('qr-code-container').classList.remove('loading');
                this.showToast('Please fix input errors.', 'danger');
                return;
            }

            const dotColors = this.getGradientColors('dot');
            const bgColors = this.getGradientColors('bg');

            const options = {
                data: this.getQrData(),
                image: this.logoImage,
                imageOptions: { 
                    crossOrigin: "anonymous", 
                    margin: 8, 
                    imageSize: parseFloat(document.getElementById('image-size').value),
                },
                qrOptions: { errorCorrectionLevel: 'H' },
                dotsOptions: { 
                    type: document.getElementById('dot-style').value,
                    gradient: dotColors.length > 1 ? {
                        type: document.getElementById('dot-gradient-type').value,
                        rotation: parseFloat(document.getElementById('dot-gradient-rotation').value) * Math.PI / 180,
                        colorStops: dotColors.map((color, index) => ({ offset: index / (dotColors.length - 1 || 1), color: color }))
                    } : null,
                    color: dotColors[0] || "#3b82f6"
                },
                backgroundOptions: { 
                    gradient: bgColors.length > 1 ? {
                        type: document.getElementById('bg-gradient-type').value,
                        rotation: parseFloat(document.getElementById('bg-gradient-rotation').value) * Math.PI / 180,
                        colorStops: bgColors.map((color, index) => ({ offset: index / (bgColors.length - 1 || 1), color: color }))
                    } : null,
                    color: bgColors[0] || "#0d0d1a"
                },
                cornersSquareOptions: { 
                    color: document.getElementById('corner-square-color').value, 
                    type: document.getElementById('corner-square-style').value 
                },
                cornersDotOptions: { 
                    color: document.getElementById('corner-dot-color').value,
                    type: document.getElementById('corner-dot-style').value
                },
                margin: parseInt(document.getElementById('margin').value || 0),
            };

            this.qrCode.update(options);
            
            setTimeout(() => {
                document.getElementById('qr-code-container').classList.remove('loading');
                this.addQrToHistory(options.data);
            }, 500);
        },

        handleLogoUpload(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                this.logoImage = e.target.result;
                this.generateQrCode();
                this.extractColorsFromImage(this.logoImage);
                document.getElementById('logo-controls').style.display = 'block';
                this.showToast('Logo uploaded!');
            };
            reader.readAsDataURL(file);
        },

        removeLogo() {
            this.logoImage = null;
            this.generateQrCode();
            document.getElementById('logo-upload').value = '';
            document.getElementById('logo-palette-container').style.display = 'none';
            document.getElementById('logo-controls').style.display = 'none';
            this.showToast('Logo removed!');
        },

        extractColorsFromImage(imageUrl) {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = imageUrl;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const scale = Math.min(100 / img.width, 100 / img.height);
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                const colorCount = {};
                for (let i = 0; i < imageData.length; i += 4 * 4) {
                    if (imageData[i+3] < 255) continue;
                    const rgb = `rgb(${imageData[i]}, ${imageData[i+1]}, ${imageData[i+2]})`;
                    colorCount[rgb] = (colorCount[rgb] || 0) + 1;
                }
                const sortedColors = Object.keys(colorCount).sort((a, b) => colorCount[b] - colorCount[a]);
                this.displayColorPalette(sortedColors.slice(0, 5));
            };
            img.onerror = () => {
                console.error("Failed to load image for color extraction.");
                document.getElementById('logo-palette-container').style.display = 'none';
            };
        },

        displayColorPalette(colors) {
            const paletteContainer = document.getElementById('logo-palette');
            paletteContainer.innerHTML = '';
            colors.forEach(color => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'palette-color';
                colorDiv.style.backgroundColor = color;
                colorDiv.setAttribute('role', 'button');
                colorDiv.setAttribute('aria-label', `Select color ${this.rgbToHex(color)}`);
                colorDiv.tabIndex = 0;
                colorDiv.addEventListener('click', () => {
                    document.getElementById('dot-color').value = this.rgbToHex(color);
                    document.getElementById('corner-square-color').value = this.rgbToHex(color);
                    document.getElementById('corner-dot-color').value = this.rgbToHex(color);
                    this.generateQrCode();
                    this.showToast(`Color ${this.rgbToHex(color).toUpperCase()} applied!`);
                });
                colorDiv.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        colorDiv.click();
                    }
                });
                paletteContainer.appendChild(colorDiv);
            });
            document.getElementById('logo-palette-container').style.display = 'block';
        },

        addGradientColor(type) {
            const container = document.getElementById(`${type}-gradient-colors`);
            const newPicker = document.createElement('div');
            newPicker.className = 'gradient-picker';
            newPicker.innerHTML = `
                <input type="color" class="qr-input" data-gradient-stop="${container.children.length}" value="#ffffff" aria-label="${type} gradient color stop ${container.children.length + 1}">
                <button onclick="App.removeGradientColor(this, '${type}')" aria-label="Remove ${type} gradient color"><i class="fas fa-minus-circle" aria-hidden="true"></i></button>
            `;
            container.appendChild(newPicker);
            newPicker.querySelector('input[type="color"]').addEventListener('input', () => {
                this.saveStateForUndo();
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => this.generateQrCode(), 250);
                this.saveAppSettings();
            });
            this.generateQrCode();
            this.showToast('Gradient color added!');
        },

        removeGradientColor(button, type) {
            const container = document.getElementById(`${type}-gradient-colors`);
            if (container.children.length > 1) {
                this.saveStateForUndo();
                button.closest('.gradient-picker').remove();
                this.generateQrCode();
                this.saveAppSettings();
                this.showToast('Gradient color removed!');
            } else {
                this.showToast('Cannot remove the last gradient color.', 'warning');
            }
        },

        async download(extension) {
            this.showToast(`Generating ${extension.toUpperCase()}...`, 'primary');
            const frameText = document.getElementById('frame-text').value;
            const frameColor = document.getElementById('frame-color').value;
            const frameFontColor = document.getElementById('frame-font-color').value;
            const frameCornerRadius = parseInt(document.getElementById('frame-corner-radius').value);

            if (!frameText) {
                this.qrCode.download({ name: "vinnesia-qr", extension });
                this.showToast(`Downloading QR code as ${extension.toUpperCase()}!`);
                return;
            }

            const qrBlob = await this.qrCode.getRawData(extension === 'svg' ? 'svg' : 'png');
            if (!qrBlob) {
                this.showToast('Failed to generate QR code for download.', 'danger');
                return;
            }
            const qrImageURL = URL.createObjectURL(qrBlob);

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const qrSize = 512;
            const padding = 60;
            const fontSize = 32;
            const totalHeight = qrSize + padding * 2 + fontSize + 20;

            canvas.width = qrSize + padding * 2;
            canvas.height = totalHeight;

            ctx.fillStyle = frameColor;
            this.roundRect(ctx, 0, 0, canvas.width, canvas.height, frameCornerRadius / 100 * (canvas.width / 2));
            ctx.fill();
            
            ctx.font = `bold ${fontSize}px Poppins`;
            ctx.fillStyle = frameFontColor;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(frameText.toUpperCase(), canvas.width / 2, padding / 2 + (fontSize / 2) + 10);

            const img = new Image();
            img.src = qrImageURL;
            img.onload = () => {
                ctx.drawImage(img, padding, padding + fontSize + 20, qrSize, qrSize);
                URL.revokeObjectURL(qrImageURL);

                if (extension === 'png') {
                    const link = document.createElement('a');
                    link.download = `vinnesia-qr-framed.png`;
                    link.href = canvas.toDataURL(`image/png`);
                    link.click();
                } else if (extension === 'svg') {
                    const link = document.createElement('a');
                    link.download = `vinnesia-qr-framed.png`;
                    link.href = canvas.toDataURL(`image/png`);
                    link.click();
                    this.showToast('Framed SVG not fully supported, downloading as PNG.', 'warning');
                }
                this.showToast(`Downloading QR code as ${extension.toUpperCase()}!`);
            };
            img.onerror = () => {
                this.showToast('Failed to load QR image for framing.', 'danger');
            };
        },

        roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        },

        async handleBulkGenerate() {
            const type = document.getElementById('bulk-type').value;
            const rawData = document.getElementById('bulk-data').value.trim();
            if (!rawData) {
                this.showToast('Please enter data for bulk generation.', 'danger');
                return;
            }
            const dataLines = rawData.split('\n');

            const zip = new JSZip();
            const tempQr = new QRCodeStyling({ ...this.qrCode.options });
            
            const bulkGenerateButton = document.getElementById('bulk-generate-zip');
            bulkGenerateButton.innerHTML = '<i class="fas fa-spinner fa-spin" aria-hidden="true"></i> Generating...';
            bulkGenerateButton.disabled = true;

            try {
                for (let i = 0; i < dataLines.length; i++) {
                    let qrDataString = dataLines[i].trim();
                    if (!qrDataString) continue;

                    let generatedQrData = qrDataString;

                    switch (type) {
                        case 'vcard':
                            const parts = qrDataString.split(',');
                            generatedQrData = `BEGIN:VCARD\nVERSION:3.0\nFN:${parts[0] || ''}\nORG:${parts[1] || ''}\nTEL:${parts[2] || ''}\nEMAIL:${parts[3] || ''}\nEND:VCARD`;
                            break;
                        case 'wifi':
                            const wifiParts = qrDataString.split(',');
                            const wifiSsid = wifiParts[0] || '';
                            const wifiPass = wifiParts[1] || '';
                            const wifiEnc = wifiParts[2] || 'WPA';
                            generatedQrData = `WIFI:S:${wifiSsid};T:${wifiEnc};P:${wifiPass};;`;
                            break;
                        case 'email':
                            const emailParts = qrDataString.split(',');
                            generatedQrData = `mailto:${emailParts[0] || ''}?subject=${encodeURIComponent(emailParts[1] || '')}&body=${encodeURIComponent(emailParts[2] || '')}`;
                            break;
                        case 'sms':
                            const smsParts = qrDataString.split(',');
                            generatedQrData = `SMSTO:${smsParts[0] || ''}:${smsParts[1] || ''}`;
                            break;
                        case 'location':
                            const locParts = qrDataString.split(',');
                            generatedQrData = `geo:${locParts[0] || ''},${locParts[1] || ''}`;
                            break;
                        case 'phone':
                            generatedQrData = `tel:${qrDataString}`;
                            break;
                        case 'whatsapp':
                            const waParts = qrDataString.split(',');
                            const waNumber = waParts[0].replace(/\D/g, '') || '';
                            const waMessage = waParts[1] || '';
                            generatedQrData = `https://wa.me/${waNumber}?text=${encodeURIComponent(waMessage)}`;
                            break;
                        case 'text':
                        default:
                            generatedQrData = qrDataString;
                            break;
                    }
                    
                    tempQr.update({ data: generatedQrData });
                    const blob = await tempQr.getRawData('png');
                    zip.file(`qr_code_${type}_${i + 1}.png`, blob);
                }

                zip.generateAsync({ type: 'blob' }).then(content => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = 'vinnesia-bulk-qrcodes.zip';
                    link.click();
                    URL.revokeObjectURL(link.href);
                    this.showToast('Bulk QR codes downloaded as ZIP!');
                    this.closeAllModals();
                });
            } catch (error) {
                console.error("Bulk generation error:", error);
                this.showToast('Error during bulk generation. Check your data format.', 'danger');
            } finally {
                bulkGenerateButton.innerHTML = '<i class="fas fa-file-archive" aria-hidden="true"></i> Generate & Download ZIP';
                bulkGenerateButton.disabled = false;
            }
        },

        openModal(modalId) {
            this.closeAllModals();
            const modal = document.getElementById(modalId);
            modal.classList.add('show');
            document.body.classList.add('modal-open');
            modal.focus();

            if (modalId === 'scanner-modal') this.startScanner();
        },

        closeAllModals() {
            document.querySelectorAll('.modal-overlay.show').forEach(m => m.classList.remove('show'));
            document.body.classList.remove('modal-open');
            this.stopScanner();
            if (this.lastFocusedElement) {
                this.lastFocusedElement.focus();
                this.lastFocusedElement = null;
            }
        },

        setupModalFocusManagement() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                        const firstFocusableElement = focusableElements[0];
                        const lastFocusableElement = focusableElements[focusableElements.length - 1];

                        if (e.shiftKey) {
                            if (document.activeElement === firstFocusableElement) {
                                lastFocusableElement.focus();
                                e.preventDefault();
                            }
                        } else {
                            if (document.activeElement === lastFocusableElement) {
                                firstFocusableElement.focus();
                                e.preventDefault();
                            }
                        }
                    }
                });
            });
        },

        startScanner() {
            if (!this.html5QrCode) {
                this.html5QrCode = new Html5Qrcode("qr-scanner-container");
            }
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            const scannerResultElement = document.getElementById('scanner-result');
            scannerResultElement.textContent = "Align QR code within the frame.";

            this.html5QrCode.start({ facingMode: "environment" }, config, 
                (decodedText, decodedResult) => {
                    scannerResultElement.textContent = decodedText;
                    this.stopScanner();
                    this.showToast('QR Code scanned successfully!');
                },
                (errorMessage) => {}
            ).catch(err => {
                scannerResultElement.textContent = "Scanner Error. Please grant camera permission.";
                this.showToast('Camera permission denied or scanner error.', 'danger');
                console.error("QR Scanner failed to start:", err);
            });
        },

        stopScanner() {
            if (this.html5QrCode && this.html5QrCode.isScanning) {
                this.html5QrCode.stop().catch(err => {
                    console.error("Failed to stop scanner:", err);
                });
            }
        },
        
        openTab(evt, tabName) {
            this.saveStateForUndo();
            
            const prevTabIndex = this.state.currentTabIndex;
            this.state.currentTab = tabName;
            this.state.currentTabIndex = parseInt(evt ? evt.currentTarget.dataset.tabIndex : document.querySelector(`.tab-button[data-tab-name="${tabName}"]`).dataset.tabIndex, 10);
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });
            const activeTabButton = evt ? evt.currentTarget : document.querySelector(`.tab-button[data-tab-name="${tabName}"]`);
            activeTabButton.classList.add('active');
            activeTabButton.setAttribute('aria-selected', 'true');
            
            document.querySelector('.tabs-content-wrapper').setAttribute('aria-labelledby', `tab-${tabName}`);


            const wrapper = document.querySelector('.tabs-content-wrapper');
            wrapper.style.transform = `translateX(-${this.state.currentTabIndex * 100}%)`;

            this.generateQrCode();
            
            const currentTabElement = document.getElementById(tabName);
            const primaryInput = currentTabElement ? currentTabElement.querySelector('.qr-input') : null;
            if (primaryInput && this.placeholderTexts[tabName]) {
                this.startTypingAnimation(primaryInput.id, this.placeholderTexts[tabName]);
            }
        },

        rgbToHex(rgbStr) {
            const match = rgbStr.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
            if (!match) return '#000000';
            const toHex = (c) => ('0' + parseInt(c, 10).toString(16)).slice(-2);
            return `#${toHex(match[1])}${toHex(match[2])}${toHex(match[3])}`;
        },

        startTypingAnimation(elementId, placeholderText) {
            const inputElement = document.getElementById(elementId);
            if (!inputElement || inputElement.value.length > 0) return;

            clearInterval(this.typingAnimationInterval);

            let i = 0;
            inputElement.placeholder = '';
            this.typingAnimationInterval = setInterval(() => {
                if (i < placeholderText.length) {
                    inputElement.placeholder += placeholderText[i];
                    i++;
                } else {
                    clearInterval(this.typingAnimationInterval);
                }
            }, 50);
        },

        validateInput(inputElement, showAlert = false) {
            const formGroup = inputElement.closest('.form-group');
            if (!formGroup) return true;

            const validationMessage = formGroup.querySelector('.validation-message');
            let isValid = true;
            let message = '';

            if (inputElement.required && inputElement.value.trim() === '') {
                isValid = false;
                message = `${inputElement.previousElementSibling?.textContent || inputElement.placeholder} is required.`;
            } else if (inputElement.type === 'email' && inputElement.value.trim() !== '' && !/\S+@\S+\.\S+/.test(inputElement.value)) {
                isValid = false;
                message = 'Please enter a valid email address.';
            } else if (inputElement.type === 'url' && inputElement.value.trim() !== '' && !/^https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&//=]*)$/.test(inputElement.value)) {
                isValid = false;
                message = 'Please enter a valid URL (e.g., https://example.com).';
            } else if (inputElement.id === 'file-upload' && inputElement.files[0] && inputElement.files[0].size > 1024 * 1024) {
                isValid = false;
                message = 'File size exceeds 1MB.';
            } else if (inputElement.id === 'location-lat' && (isNaN(inputElement.value) || parseFloat(inputElement.value) < -90 || parseFloat(inputElement.value) > 90)) {
                isValid = false;
                message = 'Latitude must be between -90 and 90.';
            } else if (inputElement.id === 'location-lon' && (isNaN(inputElement.value) || parseFloat(inputElement.value) < -180 || parseFloat(inputElement.value) > 180)) {
                isValid = false;
                message = 'Longitude must be between -180 and 180.';
            }

            if (isValid) {
                formGroup.classList.remove('invalid');
                if (validationMessage) {
                    validationMessage.style.display = 'none';
                    validationMessage.textContent = '';
                }
            } else {
                formGroup.classList.add('invalid');
                if (validationMessage) {
                    validationMessage.textContent = message;
                    validationMessage.style.display = 'block';
                }
                if (showAlert) {
                    this.showToast(message, 'danger');
                }
            }
            return isValid;
        },

        updateCharacterCounter(inputElement) {
            const counterElement = document.getElementById(`${inputElement.id}-counter`);
            if (counterElement) {
                const maxLength = inputElement.maxLength || 250;
                const currentLength = inputElement.value.length;
                counterElement.textContent = `${currentLength}/${maxLength}`;

                if (currentLength > maxLength * 0.9) {
                    counterElement.classList.add('danger');
                    counterElement.classList.remove('warning');
                } else if (currentLength > maxLength * 0.7) {
                    counterElement.classList.add('warning');
                    counterElement.classList.remove('danger');
                } else {
                    counterElement.classList.remove('warning', 'danger');
                }
            }
        },

        copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    this.showToast('Copied to clipboard!');
                }).catch(err => {
                    console.warn('Failed to copy via clipboard API, falling back to document.execCommand:', err);
                    this._fallbackCopyToClipboard(text);
                });
            } else {
                this._fallbackCopyToClipboard(text);
            }
        },

        _fallbackCopyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
                this.showToast('Copied to clipboard!');
            } catch (err) {
                this.showToast('Failed to copy to clipboard.', 'danger');
                console.error('Fallback copy failed: ', err);
            } finally {
                document.body.removeChild(textarea);
            }
        },

        showToast(message, type = 'success', duration = 3000) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `toast-notification show ${type}`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        },

        handleFileUpload(file) {
            if (!file) {
                document.getElementById('file-upload-name').textContent = '';
                document.getElementById('file').classList.remove('invalid');
                document.querySelector('#file .validation-message').style.display = 'none';
                return;
            };

            const fileNameDisplay = document.getElementById('file-upload-name');
            const formGroup = document.getElementById('file').querySelector('.form-group');
            const validationMessage = formGroup.querySelector('.validation-message');

            if (file.size > 1024 * 1024) {
                fileNameDisplay.textContent = `File: ${file.name} (Too large!)`;
                formGroup.classList.add('invalid');
                validationMessage.textContent = 'File size exceeds 1MB.';
                validationMessage.style.display = 'block';
                this.showToast('File size too large (max 1MB).', 'danger');
                document.getElementById('file-upload-name').dataset.fileContent = '';
                return;
            } else {
                formGroup.classList.remove('invalid');
                validationMessage.style.display = 'none';
            }

            fileNameDisplay.textContent = `File: ${file.name}`;
            const reader = new FileReader();
            reader.onload = (e) => {
                fileNameDisplay.dataset.fileContent = e.target.result;
                this.generateQrCode();
                this.showToast('File uploaded and ready for QR generation!');
            };
            reader.readAsDataURL(file);
        },

        addQrToHistory(data) {
            const timestamp = new Date().toLocaleString();
            const newEntry = { data, timestamp, type: this.state.currentTab };
            
            this.state.qrHistory = this.state.qrHistory.filter(item => item.data !== data);

            this.state.qrHistory.unshift(newEntry);
            if (this.state.qrHistory.length > this.maxHistoryItems) {
                this.state.qrHistory.pop();
            }
            localStorage.setItem('qrHistory', JSON.stringify(this.state.qrHistory));
            this.renderHistory();
        },

        loadHistory() {
            this.renderHistory();
        },

        renderHistory() {
            const historyList = document.getElementById('qr-history-list');
            historyList.innerHTML = '';
            if (this.state.qrHistory.length === 0) {
                historyList.innerHTML = '<li class="text-gray-500">No recent QR codes.</li>';
                return;
            }
            this.state.qrHistory.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center py-2 px-3 bg-gray-800 rounded-lg mb-2 hover:bg-gray-700 transition-colors duration-200';
                li.innerHTML = `
                    <span class="text-sm text-gray-300 overflow-hidden whitespace-nowrap overflow-ellipsis max-w-[calc(100%-100px)]">
                        <strong>${item.type.charAt(0).toUpperCase() + item.type.slice(1)}:</strong> ${item.data.substring(0, 50)}${item.data.length > 50 ? '...' : ''}
                        <span class="text-xs text-gray-500 block" aria-label="Generated on">${item.timestamp}</span>
                    </span>
                    <div>
                        <button class="btn btn-outline btn-sm mr-2" onclick="App.loadQrFromHistory(${index})" aria-label="Load this QR code into generator"><i class="fas fa-redo" aria-hidden="true"></i> Load</button>
                        <button class="btn btn-danger btn-sm" onclick="App.removeQrFromHistory(${index})" aria-label="Remove this QR code from history"><i class="fas fa-trash-alt" aria-hidden="true"></i></button>
                    </div>
                `;
                historyList.appendChild(li);
            });
        },

        loadQrFromHistory(index) {
            const item = this.state.qrHistory[index];
            if (item) {
                this.saveStateForUndo(); 

                const targetTabButton = document.querySelector(`.tab-button[data-tab-name="${item.type}"]`);
                if (targetTabButton) {
                    this.openTab(null, item.type);

                    const targetInputId = this.findMainInputIdForTab(item.type);
                    const targetInput = document.getElementById(targetInputId);
                    if (targetInput) {
                        targetInput.value = item.data;
                        this.generateQrCode();
                        this.showToast(`Loaded QR from history (${item.type})!`);
                    } else {
                        console.error(`Main input not found for tab: ${item.type}`);
                        this.showToast('Could not load QR. Input field not found.', 'danger');
                    }
                } else {
                    this.showToast('Could not load QR. Tab not found.', 'danger');
                }
            }
        },

        findMainInputIdForTab(tabName) {
            switch (tabName) {
                case 'text': return 'text-input';
                case 'wifi': return 'wifi-ssid';
                case 'vcard': return 'vcard-name';
                case 'email': return 'email-to';
                case 'sms': return 'sms-number';
                case 'location': return 'location-lat';
                case 'file': return 'file-upload-name';
                case 'event': return 'event-summary';
                case 'crypto': return 'crypto-address';
                case 'phone': return 'phone-number';
                case 'whatsapp': return 'whatsapp-number';
                case 'social': return 'social-url';
                case 'appstore': return 'appstore-url';
                case 'multilang': return 'multilang-default';
                case 'html': return 'html-content';
                default: return 'text-input';
            }
        },

        removeQrFromHistory(index) {
            this.state.qrHistory.splice(index, 1);
            localStorage.setItem('qrHistory', JSON.stringify(this.state.qrHistory));
            this.renderHistory();
            this.showToast('QR code removed from history.', 'danger');
        },

        clearHistory() {
            if (confirm('Are you sure you want to clear all QR history?')) {
                this.state.qrHistory = [];
                localStorage.setItem('qrHistory', JSON.stringify(this.state.qrHistory));
                this.renderHistory();
                this.showToast('QR history cleared.', 'danger');
            }
        },

        saveAppSettings() {
            const settings = {};
            document.querySelectorAll('.qr-input').forEach(input => {
                if (input.id) {
                    if (input.type === 'color' || input.type === 'range' || input.type === 'number') {
                        settings[input.id] = input.value;
                    } else if (input.type === 'checkbox') {
                        settings[input.id] = input.checked;
                    } else {
                        settings[input.id] = input.value;
                    }
                }
            });
            settings.dotGradientColors = this.getGradientColors('dot');
            settings.bgGradientColors = this.getGradientColors('bg');
            settings.currentTab = this.state.currentTab;
            settings.currentTabIndex = this.state.currentTabIndex;
            settings.theme = this.state.appSettings.theme;

            this.state.appSettings = settings;
            localStorage.setItem('appSettings', JSON.stringify(this.state.appSettings));
        },

        applyInitialSettings() {
            const savedSettings = this.state.appSettings;
            if (!savedSettings) return;

            this.loadTheme();

            for (const id in savedSettings) {
                const inputElement = document.getElementById(id);
                if (inputElement && id !== 'dotGradientColors' && id !== 'bgGradientColors' && id !== 'currentTab' && id !== 'currentTabIndex' && id !== 'theme') {
                    if (inputElement.type === 'color' || inputElement.type === 'text' || inputElement.type === 'textarea' || inputElement.type === 'select-one' || inputElement.type === 'number' || inputElement.type === 'range') {
                        inputElement.value = savedSettings[id];
                        this.updateCharacterCounter(inputElement);
                        if (inputElement.type === 'range') {
                            const valueSpan = document.getElementById(`${id}-value`);
                            if (valueSpan) valueSpan.textContent = savedSettings[id];
                        }
                    } else if (inputElement.type === 'checkbox') {
                        inputElement.checked = savedSettings[id];
                    }
                }
            }

            this.renderGradientColors('dot', savedSettings.dotGradientColors);
            this.renderGradientColors('bg', savedSettings.bgGradientColors);

            if (savedSettings.currentTab) {
                const targetTabButton = document.querySelector(`.tab-button[data-tab-name="${savedSettings.currentTab}"]`);
                if (targetTabButton) {
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                        btn.setAttribute('aria-selected', 'false');
                    });
                    targetTabButton.classList.add('active');
                    targetTabButton.setAttribute('aria-selected', 'true');
                    this.state.currentTab = savedSettings.currentTab;
                    this.state.currentTabIndex = savedSettings.currentTabIndex;
                    const wrapper = document.querySelector('.tabs-content-wrapper');
                    wrapper.style.transform = `translateX(-${this.state.currentTabIndex * 100}%)`;
                    document.querySelector('.tabs-content-wrapper').setAttribute('aria-labelledby', `tab-${savedSettings.currentTab}`);
                }
            }
            
            this.generateQrCode();
        },

        renderGradientColors(prefix, colorsArray) {
            const container = document.getElementById(`${prefix}-gradient-colors`);
            container.innerHTML = '';

            if (!colorsArray || colorsArray.length === 0) {
                colorsArray = (prefix === 'dot') ? ['#3b82f6', '#8b5cf6'] : ['#0d0d1a', '#1a1a2e'];
            }

            colorsArray.forEach((color, index) => {
                const newPicker = document.createElement('div');
                newPicker.className = 'gradient-picker';
                let removeButton = '';
                if (colorsArray.length > 1) {
                    removeButton = `<button onclick="App.removeGradientColor(this, '${prefix}')" aria-label="Remove ${prefix} gradient color"><i class="fas fa-minus-circle" aria-hidden="true"></i></button>`;
                }
                newPicker.innerHTML = `
                    <input type="color" class="qr-input" data-gradient-stop="${index}" value="${color}" aria-label="${prefix} gradient color stop ${index + 1}">
                    ${removeButton}
                `;
                container.appendChild(newPicker);
                newPicker.querySelector('input[type="color"]').addEventListener('input', () => {
                    this.saveStateForUndo();
                    clearTimeout(this.debounceTimer);
                    this.debounceTimer = setTimeout(() => this.generateQrCode(), 250);
                    this.saveAppSettings();
                });
            });
            const addButton = document.createElement('button');
            addButton.className = 'btn btn-outline btn-sm mt-2';
            addButton.innerHTML = '<i class="fas fa-plus-circle" aria-hidden="true"></i> Add Color';
            addButton.onclick = () => this.addGradientColor(prefix);
            addButton.setAttribute('aria-label', `Add ${prefix} gradient color`);
            container.appendChild(addButton);
        },

        saveStateForUndo() {
            const currentState = this.getCurrentAppState();
            if (this.state.undoStack.length === 0 || JSON.stringify(this.state.undoStack[this.state.undoStack.length - 1]) !== JSON.stringify(currentState)) {
                this.state.undoStack.push(currentState);
                this.state.redoStack = [];
                if (this.state.undoStack.length > 50) {
                    this.state.undoStack.shift();
                }
            }
        },

        getCurrentAppState() {
            const state = {};
            document.querySelectorAll('.qr-input').forEach(input => {
                if (input.id) {
                    state[input.id] = input.type === 'checkbox' ? input.checked : input.value;
                }
            });
            state.currentTab = this.state.currentTab;
            state.currentTabIndex = this.state.currentTabIndex;
            state.logoImage = this.logoImage;
            state.dotGradientColors = this.getGradientColors('dot');
            state.bgGradientColors = this.getGradientColors('bg');
            return state;
        },

        applyAppState(state) {
            for (const id in state) {
                const inputElement = document.getElementById(id);
                if (inputElement) {
                    if (inputElement.type === 'checkbox') {
                        inputElement.checked = state[id];
                    } else if (inputElement.id !== 'file-upload-name') {
                        inputElement.value = state[id];
                        this.updateCharacterCounter(inputElement);
                        if (inputElement.type === 'range') {
                            const valueSpan = document.getElementById(`${id}-value`);
                            if (valueSpan) valueSpan.textContent = state[id];
                        }
                    }
                }
            }
            this.openTab(null, state.currentTab);
            this.logoImage = state.logoImage;
            this.renderGradientColors('dot', state.dotGradientColors);
            this.renderGradientColors('bg', state.bgGradientColors);

            this.generateQrCode();
        },

        undo() {
            if (this.state.undoStack.length > 1) {
                const currentState = this.state.undoStack.pop();
                this.state.redoStack.push(currentState);
                const previousState = this.state.undoStack[this.state.undoStack.length - 1];
                this.applyAppState(previousState);
                this.showToast('Undo successful!');
            } else {
                this.showToast('Nothing to undo.', 'warning');
            }
        },

        redo() {
            if (this.state.redoStack.length > 0) {
                const nextState = this.state.redoStack.pop();
                this.state.undoStack.push(nextState);
                this.applyAppState(nextState);
                this.showToast('Redo successful!');
            } else {
                this.showToast('Nothing to redo.', 'warning');
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => App.init());

    document.body.classList.add('modal-open'); 
    </script>
</body>
</html>
